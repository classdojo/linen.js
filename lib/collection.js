// Generated by CoffeeScript 1.6.2
(function() {
  var Collection, Model, bindable, flatstack, memoize, payload, _,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  bindable = require("bindable");

  payload = require("./payload");

  _ = require("underscore");

  Model = require("./model");

  flatstack = require("flatstack");

  memoize = require("memoizee");

  Collection = (function(_super) {
    __extends(Collection, _super);

    /*
    */


    Collection.prototype.__isCollection = true;

    /*
    */


    function Collection(field) {
      var _this = this;

      this.field = field;
      Collection.__super__.constructor.call(this);
      this._callstack = flatstack();
      this._callstack.error(function(err) {
        return console.error(err);
      });
      this.transform().map(function(model) {
        model = field.map(model);
        model.owner = _this.owner;
        _this._watchRemove(model);
        return model;
      });
      this.on({
        insert: this._persistInsert,
        remove: this._persistRemove,
        reset: this._persistReset
      });
      this.fetch = memoize((function(next) {
        return this._fetch(next);
      }), {
        maxAge: 1000 * 5,
        async: true
      });
    }

    /*
    */


    Collection.prototype.model = function(data) {
      var model,
        _this = this;

      model = this.field.linen.model(this.field.options.ref, data);
      model.collection = this;
      model.owner = this.owner;
      model.once("save", function(err) {
        if (err != null) {
          return;
        }
        _this._ignorePersist = true;
        _this.push(model);
        return _this._ignorePersist = false;
      });
      this._watchRemove(model);
      return model;
    };

    /*
    */


    Collection.prototype.clear = function() {
      var model, source, _i, _len, _results;

      source = this.source().concat();
      _results = [];
      for (_i = 0, _len = source.length; _i < _len; _i++) {
        model = source[_i];
        _results.push(model.remove());
      }
      return _results;
    };

    /*
    */


    Collection.prototype._watchRemove = function(model) {
      var _this = this;

      return model.once("remove", function(err) {
        var i;

        _this._ignorePersist = true;
        i = _this.indexOf(model);
        if (~i) {
          _this.splice(i, 1);
        }
        return _this._ignorePersist = false;
      });
    };

    /*
    */


    Collection.prototype.hasChanged = function() {
      var item, _i, _len, _ref;

      _ref = this.source();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        if (item.hasChanged()) {
          return true;
        }
      }
      return false;
    };

    /*
    */


    Collection.prototype._fetch = function(next) {
      var _this = this;

      if (next == null) {
        next = function() {};
      }
      if (!this.field.isVirtual()) {
        return next();
      }
      this._callstack.push(function(next) {
        return _this.field.fetch(payload.collection(_this).method("GET").data, function(err, models) {
          if (err != null) {
            return next(err);
          }
          _this._reset(models);
          return next();
        });
      });
      this._callstack.push(function() {
        return next();
      });
      return this;
    };

    /*
    */


    Collection.prototype.bind = function(options) {
      var binding;

      binding = Collection.__super__.bind.apply(this, arguments);
      this.fetch();
      return binding;
    };

    /*
    */


    Collection.prototype.save = function() {};

    /*
    */


    Collection.prototype._reset = function(source) {
      this._ignorePersist = true;
      this.source(source);
      return this._ignorePersist = false;
    };

    /*
    */


    Collection.prototype.toJSON = function() {
      var model, models, _i, _len, _ref;

      models = [];
      _ref = this.source();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        model = _ref[_i];
        models.push(model.push(model.__isModel ? model.toJSON() : model));
      }
      return models;
    };

    /*
    */


    Collection.prototype._persistInsert = function(model) {
      var _this = this;

      if (this._ignorePersist || this.owner.isNew()) {
        return;
      }
      return this._callstack.push(function(next) {
        return _this.field.fetch(payload.collection(_this).target(model).method("POST").data, next);
      });
    };

    /*
    */


    Collection.prototype._persistRemove = function(model) {
      var _this = this;

      if (this._ignorePersist || this.owner.isNew()) {
        return;
      }
      if (model.isNew()) {
        return;
      }
      return this._callstack.push(function(next) {
        return _this.field.fetch(payload.collection(_this).target(model).method("DELETE").data, next);
      });
    };

    /*
    */


    Collection.prototype._persistReset = function() {
      throw new Error("cannot persist reset (not implemented)");
    };

    return Collection;

  })(bindable.Collection);

  module.exports = Collection;

}).call(this);

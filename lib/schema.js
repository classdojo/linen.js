// Generated by CoffeeScript 1.6.2
(function() {
  var Model, Schema, flatstack, parser, type;

  type = require("type-component");

  parser = require("./fieldParser");

  Model = require("./model");

  flatstack = require("flatstack");

  Schema = (function() {
    /*
    */
    function Schema(linen, options) {
      this.linen = linen;
      if (options == null) {
        options = {};
      }
      this.name = options.name;
      this.__fetch = options.fetch;
      this.fields = parser.parse(this, options.fields);
    }

    /*
    */


    Schema.prototype.isVirtual = function() {
      return !!this.__fetch;
    };

    /*
    */


    Schema.prototype.model = function(data) {
      var d, m;

      d = {};
      if (type(data) === "string") {
        d._id = data;
      } else {
        d = data || {};
      }
      m = new Model(this);
      m.reset(d = this.fields["default"](d));
      if (!m.isNew()) {
        m.flushChanged();
      }
      return m;
    };

    /*
    */


    Schema.prototype.map = function(key, value) {
      return this.fields.map(key, value);
    };

    /*
    */


    Schema.prototype.validate = function(model) {
      return this.fields.validate(model);
    };

    /*
    */


    Schema.prototype.fetch = function(payload, next) {
      switch (payload.method) {
        case "GET":
          return this._get(payload, next);
        case "PUT":
          return this._save(payload, next);
        case "POST":
          return this._save(payload, next);
        case "DELETE":
          return this._delete(payload, next);
      }
    };

    /*
    */


    Schema.prototype._get = function(payload, next) {
      var field, _i, _len, _ref;

      _ref = this.fields.toArray();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        field = _ref[_i];
        if (!field.isVirtual()) {
          continue;
        }
        if (field != null) {
          field.fetch(payload);
        }
      }
      return this._fetch(payload, next);
    };

    /*
    */


    Schema.prototype._save = function(payload, next) {
      var callstack, changed, data, item, model, usable, _i, _len,
        _this = this;

      callstack = flatstack();
      model = payload.model;
      changed = payload.changed;
      usable = changed.filter(function(value) {
        return !_this.fields.get(value.key).isVirtual();
      });
      if (payload.method === "POST" || usableKeys.length) {
        data = {};
        for (_i = 0, _len = changed.length; _i < _len; _i++) {
          item = changed[_i];
          data[item.key] = item.nv;
        }
        callstack.push(function(next) {
          return _this._fetch(payload, next);
        });
      }
      callstack.push(function(next2) {
        return _this.fields.save(payload, function(err) {
          if (err != null) {
            return next(err);
          }
          return next2();
        });
      });
      return callstack.push(function() {
        return next();
      });
    };

    /*
    */


    Schema.prototype._delete = function(payload, next) {
      if (!payload.model.has("_id")) {
        return next(comerr.Invalid("_id must be present when deleting a model"));
      }
      return this._fetch(payload, next);
    };

    /*
    */


    Schema.prototype._fetch = function(payload, next) {
      if (next == null) {
        next = function() {};
      }
      if (!this.__fetch) {
        return next();
      }
      return this.__fetch(options, function(err, result) {
        if (err != null) {
          return next(err);
        }
        options.model.set(result);
        return next();
      });
    };

    return Schema;

  })();

  module.exports = Schema;

}).call(this);

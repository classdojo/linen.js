// Generated by CoffeeScript 1.6.2
(function() {
  var Linen, ModelPlugin, Route, mannequin, outcome;

  mannequin = require("mannequin");

  Route = require("./route");

  ModelPlugin = require("./modelPlugin");

  outcome = require("outcome");

  Linen = (function() {
    /*
    */
    function Linen(options) {
      var key;

      this.schemas = mannequin.dictionary();
      this.transport = options.transport;
      this.host = options.host;
      for (key in options.schemas) {
        ModelPlugin.plugin(this, this.schemas.register(key, options.schemas[key]));
      }
      this._route = new Route(options);
      this._transport = options.transport;
    }

    /*
    */


    Linen.prototype.item = function(path, query) {
      var modelBuilder;

      if (query == null) {
        query = {};
      }
      modelBuilder = this._modelBuilderByPath(path);
      return modelBuilder.linenBuilder.createItem(path, query);
    };

    /*
    */


    Linen.prototype.collection = function(path, query) {
      var modelBuilder;

      if (query == null) {
        query = {};
      }
      modelBuilder = this._modelBuilderByPath(path);
      return modelBuilder.linenBuilder.createCollection(path, query);
    };

    /*
    */


    Linen.prototype._request = function(options, next) {
      var o, path, ro, route;

      ro = options.item.requestOptions;
      route = this._route.route(ro.path);
      path = route.path(ro).substr(1);
      o = outcome.e(next);
      return this.transport.request({
        host: this.host,
        path: path,
        method: options.method,
        data: options.data || {}
      }, o.s(function(response) {
        return route.mapResponse(response, o.s(function(response) {
          if (options.one) {
            return next(null, route.mapItem(response));
          } else {
            return next(null, route.mapCollection(response));
          }
        }));
      }));
    };

    /*
    */


    Linen.prototype._modelBuilderByPath = function(path) {
      return this.schemas.modelBuilder(this._route.route(path).schemaName);
    };

    return Linen;

  })();

  module.exports = function(options) {
    return new Linen(options);
  };

  module.exports.Route = Route;

}).call(this);

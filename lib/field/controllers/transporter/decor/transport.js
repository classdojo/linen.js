// Generated by CoffeeScript 1.6.2
(function() {
  var Transport, dref, hashObject, type,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  hashObject = require("../memoize/hashObject");

  dref = require("dref");

  type = require("type-component");

  Transport = (function(_super) {
    __extends(Transport, _super);

    /*
    */


    function Transport() {
      Transport.__super__.constructor.apply(this, arguments);
      this._request = this.field.options.request;
      this._map = this._request.map || function(data) {
        return data;
      };
      this._memoOps = {
        maxAge: 1000 * 10
      };
    }

    /*
    */


    Transport.prototype.watching = function(options) {
      return this.request(options, function() {});
    };

    /*
    */


    Transport.prototype.request = function(options, next) {
      var currentHash, fieldHash, method, model, payload,
        _this = this;

      if (next == null) {
        next = function() {};
      }
      payload = this._getPayload(options);
      model = payload.model;
      if (payload.method === "put" && type(payload.data) === "object" && Object.keys(payload.data).length === 0) {
        return next();
      }
      console.log("OK");
      method = this._request[payload.method];
      if (!(method || (payload.method === "get" && !model.get("_id")))) {
        return next();
      }
      currentHash = this._payloadHash(payload);
      fieldHash = this._fieldHash(payload);
      return options.model._memos.call(fieldHash, currentHash, this._memoOps, next, function(next) {
        method = _this._request[payload.method];
        return method(payload, function(err, result) {
          return setTimeout((function() {
            if (err) {
              return next(err, result);
            }
            if (!result) {
              options.model._memos.replace(fieldHash, void 0);
            }
            options.model.reset(_this._map.call(model, result), _this.field.path);
            model._cache.store(_this._getPayloadData(payload, false));
            return next();
          }), 0);
        });
      });
    };

    /*
    */


    Transport.prototype._getPayload = function(options) {
      var payload;

      payload = {
        model: options.model,
        method: this._getMethod(options),
        hash: options.hash
      };
      if (/post|put/.test(payload.method)) {
        payload.data = this._getPayloadData(payload, payload.method !== "post");
        if (payload.data) {
          delete payload.data._id;
        }
      }
      return payload;
    };

    /*
    */


    Transport.prototype._getPayloadData = function(payload, pluck) {
      var d, dataFields, field, model, newData, _i, _len;

      if (pluck == null) {
        pluck = true;
      }
      model = payload.model;
      dataFields = this._getDataFields(this.field);
      d = {};
      if (this.field.parent) {
        dref.set(d, this.field.path, this.field._mapper.normalize(model, model.get(this.field.path)));
      }
      for (_i = 0, _len = dataFields.length; _i < _len; _i++) {
        field = dataFields[_i];
        newData = field._mapper.normalize(model, model.get(field.path));
        dref.set(d, field.path, newData);
      }
      if (pluck) {
        d = model._cache.pluck(d, true);
      }
      if (d && this.field.parent) {
        d = dref.get(d, this.field.path);
      }
      return d != null ? d : {};
    };

    /*
    */


    Transport.prototype._getMethod = function(options) {
      if (options.method === "get") {
        return "get";
      }
      if (options.method === "set") {
        if (options.model.get("_id")) {
          return "put";
        } else {
          return "post";
        }
      }
      return options.method;
    };

    /*
    */


    Transport.prototype._getDataFields = function(startField) {
      var field, paths, _i, _len, _ref;

      paths = [];
      _ref = startField.fields;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        field = _ref[_i];
        if (field.options.request || field.options.persist === false) {
          continue;
        }
        paths.push(field);
        paths = paths.concat(this._getDataFields(field));
      }
      return paths;
    };

    /*
    */


    Transport.prototype._fieldHash = function(payload) {
      return hashObject({
        method: payload.method,
        path: this.field.path,
        pash: payload.hash
      });
    };

    /*
    */


    Transport.prototype._payloadHash = function(payload) {
      return hashObject({
        method: payload.method,
        path: this.field.path,
        hash: payload.hash,
        data: payload.data || {}
      });
    };

    /*
    */


    Transport.test = function(field) {
      return !!field.options.request;
    };

    return Transport;

  })(require("./base"));

  module.exports = Transport;

}).call(this);

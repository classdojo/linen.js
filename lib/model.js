// Generated by CoffeeScript 1.6.2
(function() {
  var Model, Payload, bindable, _,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  bindable = require("bindable");

  _ = require("underscore");

  Payload = require("./payload");

  Model = (function(_super) {
    __extends(Model, _super);

    /*
    */


    Model.prototype.__isModel = true;

    /*
    */


    function Model(schema) {
      this.schema = schema;
      Model.__super__.constructor.call(this, {});
      this._changed = {};
    }

    /*
    */


    Model.prototype.isNew = function() {
      return !this.has("_id");
    };

    /*
    */


    Model.prototype.hasChanged = function() {
      return !!Object.keys(this._changed);
    };

    /*
    */


    Model.prototype.changed = function() {
      return this._changed;
    };

    /*
    */


    Model.prototype.changedToArray = function() {
      var cha, key;

      cha = [];
      for (key in this._changed) {
        cha.push(this._changed[key]);
      }
      return cha;
    };

    /*
    */


    Model.prototype._set = function(key, value) {
      return Model.__super__._set.call(this, key, this.schema.map(key, value));
    };

    /*
    */


    Model.prototype.flushChanged = function() {
      var ch, changed, key;

      ch = this._changed;
      this._changed = {};
      changed = [];
      for (key in ch) {
        changed.push(ch[key]);
      }
      return changed;
    };

    /*
     refreshes the model
    */


    Model.prototype.fetch = function(next) {
      return this._fetch(new Payload(this, "GET"), next);
    };

    /*
     saves the model - either adds it as a new one, or updates it
    */


    Model.prototype.save = function(next) {
      return this._fetch(new Payload(this, (this.isNew() ? "POST" : "PUT"), this.flushChanged()), next);
    };

    /*
     removes the model
    */


    Model.prototype.remove = function(next) {
      var _this = this;

      return this._fetch(new Payload(this, "DELETE"), function(err) {
        if (err != null) {
          return next(err);
        }
        return _this.emit("delete");
      });
    };

    /*
     calls .fetch() on schema, and updates this model
    */


    Model.prototype._fetch = function(payload, next) {
      var _this = this;

      if (next == null) {
        next = function() {};
      }
      return this.schema.fetch(payload, function(err, result) {
        if (err != null) {
          return err;
        }
        _this.set(result || {});
        return next();
      });
    };

    /*
     on binding, fetch this model, but don't do it all the time.
    */


    Model.prototype.bind = function(property) {
      var binding;

      binding = Model.__super__.bind.apply(this, arguments);
      if (this._ignoreFetch) {
        return binding;
      }
      this._throttledFetch();
      return binding;
    };

    /*
    */


    Model.prototype.validate = function(next) {
      var error;

      error = this.schema.validate(this);
      if (arguments.length === 1) {
        return next(error);
      } else {
        return error;
      }
    };

    /*
    */


    Model.prototype._throttledFetch = _.throttle((function() {
      return this.fetch();
    }), 1000 * 5);

    /*
    */


    Model.prototype._bindFields = function() {
      var field, _fn, _i, _len, _ref,
        _this = this;

      this._ignoreFetch = true;
      _ref = this.schema.fields.toArray();
      _fn = function(field) {
        var fieldName, fops, property, _j, _len1, _ref1, _results;

        fieldName = field.property;
        fops = field.options;
        _this.bind(fieldName).to(function(newValue, oldValue) {
          _this._changed[fieldName] = {
            key: fieldName,
            nv: newValue,
            ov: oldValue
          };
          if (fops.set) {
            return fops.set(_this, newValue, oldValue);
          }
        });
        if (fops.get) {
          _this.set(field.property, fops.get(_this));
        }
        if (fops.bind) {
          _ref1 = fops.bind;
          _results = [];
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            property = _ref1[_j];
            _results.push((function(property) {
              return _this.bind(property).to(function() {
                return _this.set(fieldName, fops.get(_this));
              });
            })(property));
          }
          return _results;
        }
      };
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        field = _ref[_i];
        _fn(field);
      }
      return this._ignoreFetch = false;
    };

    return Model;

  })(bindable.Object);

  module.exports = Model;

}).call(this);

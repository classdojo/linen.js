// Generated by CoffeeScript 1.6.2
(function() {
  var asyngleton, cstep, dref, outcome, _,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  dref = require("dref");

  outcome = require("outcome");

  cstep = require("cstep");

  asyngleton = require("asyngleton");

  _ = require("underscore");

  module.exports = function(builder, Model) {
    var linen, _ref;

    linen = builder.linen;
    return (function(_super) {
      __extends(_Class, _super);

      function _Class() {
        _ref = _Class.__super__.constructor.apply(this, arguments);
        return _ref;
      }

      /*
      */


      _Class.prototype._initData = function(data) {
        this._o = outcome.e(this);
        if (typeof data === "string") {
          data = {
            _id: data
          };
        } else {
          data = data;
        }
        return _Class.__super__._initData.call(this, data);
      };

      /*
      */


      _Class.prototype.route = function(options) {
        var _ref1;

        if (arguments.length) {
          this._route = _.extend(this._route || {}, options);
          return this;
        }
        return _.extend({}, this._route, ((_ref1 = this.definition) != null ? _ref1.options.$route : void 0) || {});
      };

      /*
      */


      _Class.prototype._set = function(key, value) {
        _Class.__super__._set.call(this, key, value);
        if (!this._update) {
          this._update = {};
        }
        return dref.set(this._update, key, value);
      };

      /*
      */


      _Class.prototype.hydrate = function(key, value) {
        this.set.apply(this, arguments);
        this._update = {};
        return this;
      };

      /*
      */


      _Class.prototype.isNew = function() {
        return !this.get("_id");
      };

      /*
      */


      _Class.prototype.fetch = asyngleton(true, function(next) {
        var request;

        request = {
          method: "GET",
          item: this
        };
        if (this.isNew()) {
          return next(new Error("cannot fetch new model"));
        }
        return this._request(request, next);
      });

      /*
      */


      _Class.prototype._request = cstep(function(options, next) {
        var _this = this;

        options.item = this;
        linen.resource.request(options, outcome.e(next).s(function(result) {
          _this.hydrate(result);
          return next();
        }));
        return this;
      });

      /*
      */


      _Class.prototype.save = function(next) {
        var o,
          _this = this;

        o = this._o.e(next);
        this.validate(o.s(function() {
          if (_this.isNew()) {
            return _this._request({
              method: "POST",
              body: _this._update
            }, o.s(function() {
              _this.parent.push(_this);
              return next.call(_this);
            }));
          } else {
            return _this._request({
              method: "PUT",
              body: _this._update
            }, next);
          }
        }));
        return this;
      };

      /*
      */


      _Class.prototype.remove = function(next) {
        if (next == null) {
          next = (function() {});
        }
        if (this.isNew()) {
          next(new Error("cannot remove a new item"));
          return this;
        }
        this._request({
          method: "DELETE"
        }, next);
        return this;
      };

      return _Class;

    })(Model);
  };

}).call(this);
